<!doctype html>

<html lang="en">
    <head>
        <meta charset="utf-8">

        <title>The HTML5 Herald</title>
        <meta name="description" content="The HTML5 Herald">
        <meta name="author" content="SitePoint">

        <link rel="stylesheet" type="text/css" href="style.css">

        <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.2.1.min.js"></script>

        <link
            rel="stylesheet"
            href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"
        />

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    </head>

    <body>

        <div id="main_container">
            <div id="container_map_sankey">
                <div id="container_sankey_info">
                    <div id="container_sankey_switch">
                        <div id="container_sankey">
                            <svg />
                        </div>
                        <div id="switch">
                            <div id="switch_countries">
                                <p> Countries </p>
                            </div>
                            <div id="switch_events">
                                <p> Events </p>
                            </div>
                        </div>
                    </div>
                    <div id="container_country_details">
                        <p> Here we want to give the user the possibility to focus on one country. For
                            example, here the user has clicked on Switzerland. If you take a look at the
                            sankey map you can see which countries are the ones where the news mention
                            Switzerland the most and, on the left, you can see the countries that Switzerland
                            mentions the most (of course this example is completely dummy, we didn't do the
                            source country computations yet). <br />

                            We also want to make it possible to do this not only for countries but also for
                            event types. For example, here on the left you might have the types of events in
                            Switzerland that are mentionned the most abroad and, on the right, you would have
                            the types of events that are mentioned the most by Switzerland.
                        </p>
                    </div>
                </div>
                <div id="container_heatmap">

                </div>
            </div>
            <div id="container_event_selection">

            </div>
        </div>

        <script
            src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js">
        </script>

        <script
            src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js">
        </script>

        <script src="https://d3js.org/d3.v4.min.js"></script>
        <script src="https://unpkg.com/d3-sankey@0.6"></script>

        <script>
            let map = L.map('container_heatmap').setView([51.505, -0.09], 13)
            let tileLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiYWhtZWRrdWxvdmljIiwiYSI6ImNqYTR2Mmp1dTlsbmoycXB5aXkyOXdtMjkifQ.sU3WNVes2qNhTFH-0nAzYA'
                })
            tileLayer.addTo(map);
            let heat;

            let eventShowing = [];
            let eventCodes;
            let selectedEventCodes;

            function showHeatmapData(){
                d3.csv('november_lat_long_eventcode.csv', function(data){

                    function isANumber(number){
                        return !isNaN(parseInt(number))
                    }

                    if(heat){
                        map.removeLayer(heat);
                    }

                    filteredGeoPoints = data.filter((row) => isANumber(row["ActionGeo_Lat"]) && isANumber(row["ActionGeo_Long"])
                        && row["EventCode"].slice(0, 2) in selectedEventCodes)
                        .map(row => L.latLng(row["ActionGeo_Lat"], row["ActionGeo_Long"]));
                    heat = L.heatLayer(filteredGeoPoints, {
                        radius: 15,
                        blur: 15,
                        maxZoom: 17,
                    }).addTo(map);
                })
            }

            d3.tsv("CAMEO.eventcodes.txt", function(data) {
                eventCodes = data.filter((cameoElem) => cameoElem.CAMEOEVENTCODE.length === 2);
                selectedEventCodes = eventCodes.map(cameoElem => cameoElem.CAMEOEVENTCODE);
                let containerEventSelection = document.getElementById("container_event_selection");

                eventCodes.forEach((cameoElem, index) => {
                    let checkboxContainer = document.createElement("div");
                    let checkboxElem = document.createElement("input");
                    checkboxElem.setAttribute("type", "checkbox");
                    checkboxElem.setAttribute("checked", true);
                    checkboxElem.onchange = function(){
                        if(checkboxElem.checked && selectedEventCodes.indexOf(cameoElem.CAMEOEVENTCODE) < 0){
                            selectedEventCodes.push(cameoElem.CAMEOEVENTCODE);
                            showHeatmapData();
                        } else if(!checkboxElem.checked){
                            let indexElem = selectedEventCodes.indexOf(cameoElem.CAMEOEVENTCODE);
                            if(indexElem >= 0){
                                selectedEventCodes.splice(indexElem, 1);
                                showHeatmapData();
                            }
                        }
                    }
                    checkboxContainer.appendChild(checkboxElem);

                    let checkboxLabel = document.createElement("label");
                    checkboxLabel.classList.add("label_event_checkbox");
                    checkboxLabel.innerHTML = cameoElem.EVENTDESCRIPTION;
                    checkboxContainer.appendChild(checkboxLabel);

                    containerEventSelection.appendChild(checkboxContainer);
                })
            })

            showHeatmapData();

            // Sankey part:

            let selectionSankeyContainer = d3.select("#container_sankey");
            let bboxSankeyContainer = selectionSankeyContainer.node().getBoundingClientRect();

            let svg = d3.select("svg"),
                width = bboxSankeyContainer.width;
                height = bboxSankeyContainer.height;

            svg.attr("width", width)
                .attr("height", height);

            let formatNumber = d3.format(",.0f"),
                format = function(d) { return formatNumber(d) + " TWh"; },
                color = d3.scaleOrdinal(d3.schemeCategory10);

            let sankey = d3.sankey()
                .nodeWidth(15)
                .nodePadding(10)
                .extent([[1, 1], [width - 1, height - 6]]);

            let link = svg.append("g")
                .attr("class", "links")
                .attr("fill", "none")
                .attr("stroke", "#000")
                .attr("stroke-opacity", 0.2)
              .selectAll("path");

            let node = svg.append("g")
                .attr("class", "nodes")
                .attr("font-family", "sans-serif")
                .attr("font-size", 10)
              .selectAll("g");

            let exampleGraph = {
                nodes: [{name: "USA"}, {name: "Italy"}, {name: "Germany"}, {name: "China"},
                    {name: "Switzerland"},
                    {name: "USA"}, {name: "France"}, {name: "Germany"}, {name: "Spain"}],
                links: [{source: 0, target: 4, value: 0.5}, {source: 1, target: 4, value: 1}, {source: 2, target: 4, value: 1.2},
                        {source: 3, target: 4, value: 1.1}, {source: 4, target: 5, value: 0.9}, {source: 4, target: 6, value: 1.9},
                        {source: 4, target: 7, value: 1.7}, {source: 4, target: 8, value: 1.4}]
                    };

            sankey(exampleGraph);

          link = link
            .data(exampleGraph.links)
            .enter().append("path")
              .attr("d", d3.sankeyLinkHorizontal())
              .attr("stroke-width", function(d) { return Math.max(1, d.width); });

          link.append("title")
              .text(function(d) { return d.source.name + " → " + d.target.name + "\n" + format(d.value); });

          node = node
            .data(exampleGraph.nodes)
            .enter().append("g");

          node.append("rect")
              .attr("x", function(d) { return d.x0; })
              .attr("y", function(d) { return d.y0; })
              .attr("height", function(d) { return d.y1 - d.y0; })
              .attr("width", function(d) { return d.x1 - d.x0; })
              .attr("fill", function(d) { return color(d.name.replace(/ .*/, "")); })
              .attr("stroke", "#000");

          node.append("text")
              .attr("x", function(d) { return d.x0 - 6; })
              .attr("y", function(d) { return (d.y1 + d.y0) / 2; })
              .attr("dy", "0.35em")
              .attr("text-anchor", "end")
              .text(function(d) { return d.name; })
            .filter(function(d) { return d.x0 < width / 2; })
              .attr("x", function(d) { return d.x1 + 6; })
              .attr("text-anchor", "start");

          node.append("title")
              .text(function(d) { return d.name + "\n" + format(d.value); });
        </script>
    </body>
</html>
